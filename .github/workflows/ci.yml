name: CI – Build,Test,Security,Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '20'
  BACKEND_CTX: ./backend
  FRONTEND_CTX: ./frontend
  IMAGE_BACKEND:  ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
  IMAGE_FRONTEND: ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
  POSTGRES_DB: myapp_dev
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/myapp_dev
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5432
  CELERY_BROKER_URL: redis://localhost:6379/0

jobs:
  # ---------- BACKEND ----------
  backend:
    name: Backend – Lint | Test | Coverage | Security
    runs-on: ubuntu-latest
    services: 
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: myapp_dev
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
       # options: >-
        #  --health-cmd 'pg_isready -U postgres'
       #   --health-interval 10s
       #   --health-timeout 5s
       #   --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    permissions:
      contents: read
      security-events: write          # for SARIF uploads
      packages: write               # for GHCR push
    steps:
      - name: Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v5 
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install & configure Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.1.3
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4 
        with:
          path: .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}

      - name: Install Python dependencies
        run: |
          cp local_settings_template.py local_settings.py
          poetry install --no-interaction --no-ansi --no-root --with dev
        working-directory: ${{ env.BACKEND_CTX }}

      - name: Run linter (Ruff)
        run: |
          source .venv/bin/activate
          ruff check .
        working-directory: ${{ env.BACKEND_CTX }}
        continue-on-error: true # Ligne ajoutée pour passer. A retirer plus tard

      - name: Run Django tests with coverage
        run: |
          source .venv/bin/activate
          poetry run coverage run -m pytest --ignore=scraper -s --junitxml=test-reports/junit/junit.xml
          poetry run coverage report
          poetry run coverage xml -o test-reports/coverage/coverage.xml
          poetry run coverage html -d test-reports/coverage/html
        working-directory: ${{ env.BACKEND_CTX }}

      - name: Upload backend coverage (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: htmlcov-backend
          path: htmlcov-backend/
          retention-days: 7

      - name: Build backend Docker image
        run: |
          docker build -f Dockerfile --target production -t ${{ env.IMAGE_BACKEND }} .
        working-directory: ${{ env.BACKEND_CTX }}

      - name: Run Trivy vulnerability scanner (backend)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_BACKEND }}
          format: sarif
          output: trivy-backend.sarif

      - name: Upload Trivy SARIF (backend)
        uses: github/codeql-action/upload-sarif@v3 # v3.28.0
        with:
          sarif_file: trivy-backend.sarif
          category: trivy-backend

      - name: Snyk scan (backend)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.IMAGE_BACKEND }}
          args: --severity-threshold=high --sarif-file-output=snyk-backend.sarif
        continue-on-error: true

      - name: Upload Snyk SARIF (backend)
        uses: github/codeql-action/upload-sarif@v3 # v3.28.0
        with:
          sarif_file: snyk-backend.sarif
          category: snyk-backend

  # ---------- FRONTEND ----------
  frontend:
    name: Frontend – Lint | Test | Coverage | Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      packages: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Node
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_CTX }}/package-lock.json

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        working-directory: ${{ env.FRONTEND_CTX }}

      - name: Run linter (ESLint)
        run: npm run lint --if-present
        working-directory: ${{ env.FRONTEND_CTX }}

      - name: Run Jest tests with coverage
        run: npm run test:coverage --if-present
        working-directory: ${{ env.FRONTEND_CTX }}

      - name: Upload frontend coverage (HTML)
        uses: actions/upload-artifact@b4b15b8c7c6acdfb0d5940cb8365a2b5f2e8c9b4 # v4.2.0
        with:
          name: htmlcov-frontend
          path: ${{ env.FRONTEND_CTX }}/coverage/
          retention-days: 7

      - name: Build frontend Docker image
        run: |
          docker build -f Dockerfile --target production -t ${{ env.IMAGE_FRONTEND }} .
        working-directory: ${{ env.FRONTEND_CTX }}

      - name: Run Trivy vulnerability scanner (frontend)
        uses: aquasecurity/trivy-action@0.28.0 # 0.29.0
        with:
          image-ref: ${{ env.IMAGE_FRONTEND }}
          format: sarif
          output: trivy-frontend.sarif

      - name: Upload Trivy SARIF (frontend)
        uses: github/codeql-action/upload-sarif@v3 # v3.28.0
        with:
          sarif_file: trivy-frontend.sarif
          category: trivy-frontend

      - name: Snyk scan (frontend)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.IMAGE_FRONTEND }}
          args: --severity-threshold=high --sarif-file-output=snyk-frontend.sarif
        continue-on-error: true

      - name: Upload Snyk SARIF (frontend)
        uses: github/codeql-action/upload-sarif@v3 # v3.28.0
        with:
          sarif_file: snyk-frontend.sarif
          category: snyk-frontend

  # ---------- SUMMARY ----------
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      - name: ✅ CI pipeline completed
        run: echo "All jobs finished successfully – ready to merge!"
